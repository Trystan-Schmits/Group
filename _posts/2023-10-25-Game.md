---
comments: False
layout: post
title: Game
description: Putting Everything Together
type: plans
courses: {'compsci': {'week': 7}}
categories: ['C4.1']
---

<style>
    .container{
        display:block;
        background-color:white;
    }
    .container2{
        width:25%;
        height:25%;
        display:inline-block;
        background-color:white;
    }
</style>
<button id="start">start</button>
<canvas id="mainDisplay" class="container" height="500px" width="500px"></canvas>
<br>
<canvas id="fadeDisplay" class="container2" height="500px" width="500px"></canvas>
<br>
<canvas id="subDisplay" class="container2" height="500px" width="500px"></canvas>
<audio id="audio" src="/Group/audio/2023-10-23-Menu_Theme.mp3" preload="auto"></audio>
<br>
<canvas id="subDisplay1" class="container2" height="500px" width="500px"></canvas>
<canvas id="subDisplay1a" class="container2" height="500px" width="500px"></canvas>
<canvas id="subDisplay1b" class="container2" height="500px" width="500px"></canvas>
<canvas id="subDisplay1c" class="container2" height="500px" width="500px"></canvas>

<script type="module">
//import needed modules
import Character from "/Group/myScripts/GameScripts/CharacterMovement.js";
import Object from "/Group/myScripts/GameScripts/CreateObject.js";
import light from "/Group/myScripts/GameScripts/Lights.js";
import {Display, subDisplay} from "/Group/myScripts/GameScripts/Displays.js";

//create objects
////////Main Menu
    //background
        //trees
        const menuBg1 = new Image();
        menuBg1.src = "/Group/images/Game/menu_tree.png"
        var menuBackgroundObject1 = new Object("menuBg1",menuBg1,[254,198],[500,500],[0,500],1,1);

        //building
        const menuBg2 = new Image();
        menuBg2.src = "/Group/images/Game/menu_building.png"
        var menuBackgroundObject2 = new Object("menuBg2",menuBg2,[254,198],[500,500],[0,500],1,1);

        //entities
        const menuBg3 = new Image();
        menuBg3.src = "/Group/images/Game/menu_entities.png"
        var menuBackgroundObject3 = new Object("menuBg3",menuBg3,[254,198],[500,500],[0,500],1,1);

        //shadow
        const menuBg4 = new Image();
        menuBg4.src = "/Group/images/Game/menu_fade.png"
        var menuBackgroundObject4 = new Object("menuBg4",menuBg4,[254,198],[500,500],[0,500],1,1);

        //sky
        const menuBg5 = new Image();
        menuBg5.src = "/Group/images/Game/menu_sky.png"
        var menuBackgroundObject5 = new Object("menuBg5",menuBg5,[500,500],[500,500],[0,500],1,1);
    
    //text
        var menuText = {text:"Start Game",font:"14px Ariel",fillStyle:"red",posX:20,posY:250}

    //audio
        var menuAudio = document.getElementById("audio");

////////Part 1
   //main character
    var myCharacter = new Character();
    document.addEventListener("keydown",myCharacter.handleKeydown.bind(myCharacter));
    document.addEventListener("keyup",myCharacter.handleKeyup.bind(myCharacter));
    var characterSpriteSheet = new Image();
    characterSpriteSheet.src = "/Group/images/Game/walking-sprite2.png";
    var myCharacterObject = new Object("character", characterSpriteSheet,[44,54],[200,266],[250,500],5,2);
    //backgrounds
        //apartment bedroom background
        var backgroundImage = new Image();
        backgroundImage.src = "/Group/images/Game/room1update.png";
        var backgroundObject = new Object("background",backgroundImage,[600,200],[1500,500],[0,500],1,1,[0,0])
        //bedroom

        //door
        var doorImage = new Image();
        doorImage.src = "/Group/images/Game/apartmentdoor.png";
        var doorObject = new Object("door",doorImage,[25,45],[185,310],[1145,500],1,1);

    //lighting
    var lightingSprite = new Image();
    lightingSprite.src = "/Group/images/Game/ShadingV3.png";
    var lightObject = new Object("light",lightingSprite,[500,500],[500,500],[0,0],1,1);

    //neighbor

    //boxes
        //small boxes
        var boxImage = new Image();
        boxImage.src = "/Group/images/Game/box1.png";
        var boxObject1 = new Object("box",boxImage,[20,16],[100,80],[500,500],1,1);
        var boxObject2 = new Object("box",boxImage,[20,16],[100,80],[725,500],1,1);
        //stacked boxes
        var boxstackImage = new Image();
        boxstackImage.src = "/Group/images/Game/box2.png"
        var boxstackObject1 = new Object("box",boxstackImage,[20,28],[120,168],[850,500],1,1);
        var boxstackObject2 = new Object("box",boxstackImage,[20,28],[100,140],[575,500],1,1);
    //E key animation
    var EkeyImage = new Image ();
        EkeyImage.src = "/Group/images/Game/EKeySprite.png"
        var Ekey= new Object ("Ekey" ,EkeyImage, [400,354],[80,100],[190,300],2,1);
        var showEKeySprite = false;
        // Add the "E" key press event listener to handle the interaction with boxObject2
        window.addEventListener('keydown', function (e) {
         // Check if the pressed key is "E" (key code 69)
        if (e.keyCode == 69) {
        // Check if the player character is in contact with boxObject2
        if (checkForOverlap(myCharacterObject, boxObject2)) {
            // Make boxObject2 disappear
            boxObject2.scale = [0, 0];
             }
         }
    });



////////////End of Object Creation, Start of Display Creation

//////Main Menu
const menuCanvas = document.getElementById("subDisplay");
var menuDisplay = new subDisplay(menuCanvas,[menuBackgroundObject5,menuBackgroundObject1,menuBackgroundObject2,menuBackgroundObject3,menuBackgroundObject4]);


//////Game Part1
var part1Canvas = document.getElementById("subDisplay1");
    //Room 1
    var part1Room1Canvas = document.getElementById("subDisplay1a");
    var part1Room1ObjectCanvas = document.getElementById("subDisplay1b");
    var part1Room1ShadowCanvas = document.getElementById("subDisplay1c");
    
    var part1Room1ObjectDisplay = new subDisplay(part1Room1ObjectCanvas,[backgroundObject,doorObject,boxstackObject2,boxObject2,myCharacterObject,boxObject1,boxstackObject1]);
    var part1Room1ShadowDisplay = new subDisplay(part1Room1ShadowCanvas,[lightObject]);
    var part1Room1Display = new Display(part1Room1Canvas,[part1Room1ObjectDisplay, part1Room1ShadowDisplay]);
var part1Display = new Display(part1Canvas,part1Room1Display);


//////fading Effect Display Object
var fadingCanvas = document.getElementById("fadeDisplay");
var fadingDisplay = new Display(fadingCanvas,fadingCanvas);


//////Main Display Object
var mainCanvas = document.getElementById("mainDisplay");
var mainDisplay = new Display(mainCanvas,menuDisplay);


////////////End of Display Creation, Start of Code

//basic variables
var fps = 24;
var currentFrame = 0;
var sec = 0;
var mouseX = 0;
var mouseY = 0;

function checkForOverlap(object1, object2) {
    var pos1 = object1.ReturnPosition().slice();
    var scale1 = object1.ReturnScale().slice();
    var xRange1 = [pos1[0], pos1[0] + scale1[0]];
    var yRange1 = [pos1[1], pos1[1] + scale1[1]];

    var pos2 = object2.ReturnPosition().slice();
    var scale2 = object2.ReturnScale().slice();
    var xRange2 = [pos2[0], pos2[0] + scale2[0]];
    var yRange2 = [pos2[1], pos2[1] + scale2[1]];

    if (
        xRange1[0] >= xRange2[0] &&
        xRange1[0] <= xRange2[1] &&
        yRange1[0] >= yRange2[0] &&
        yRange1[0] <= yRange2[1]
    ) {
        return true;
    }

    if (
        xRange1[0] >= xRange2[0] &&
        xRange1[0] <= xRange2[1] &&
        yRange1[1] >= yRange2[0] &&
        yRange1[1] <= yRange2[1]
    ) {
        return true;
    }

    if (
        xRange1[1] >= xRange2[0] &&
        xRange1[1] <= xRange2[1] &&
        yRange1[0] >= yRange2[0] &&
        yRange1[0] <= yRange2[1]
    ) {
        return true;
    }

    if (
        xRange1[1] >= xRange2[0] &&
        xRange1[1] <= xRange2[1] &&
        yRange1[1] >= yRange2[0] &&
        yRange1[1] <= yRange2[1]
    ) {
        return true;
    }

    return false;
}


var fadingFrame = 0;
var fadingCtx = fadingCanvas.getContext("2d")
function Fadeframe(oldDisplay,newDisplay,ac1,ac2,func,aud1,aud2){
    console.log(func)
fadingFrame = (fadingFrame+1)%(2*fps);

if(fadingFrame < fps){
    if(fadingFrame !==0){
    mainDisplay.activeDisplay = [oldDisplay,fadingDisplay];
    }
    fadingCtx.clearRect(0,0,fadingCanvas.width,fadingCanvas.height)
    var imageData = new ImageData(fadingCanvas.width,fadingCanvas.height);
    var data = imageData.data;
    for(let i = 3; i<data.length; i+=4){
        data[i] = 255*((fadingFrame/fps))
    }
    fadingCtx.putImageData(imageData,0,0);
}
else{
    mainDisplay.activeDisplay = [newDisplay,fadingDisplay];
    fadingCtx.clearRect(0,0,fadingCanvas.width,fadingCanvas.height)
    var imageData = new ImageData(fadingCanvas.width,fadingCanvas.height);
    var data = imageData.data;
    for(let i = 3; i<data.length; i+=4){
        data[i] = 255*((2*fps-fadingFrame)/fps)
    }
    fadingCtx.putImageData(imageData,0,0);
}

if(fadingFrame == fps){ //change canvas, stop updating canvas1, start updating newcanvas
    currentFrame = 0;
    sec = 0;
    ac1 = false;
    ac2 = true;
    func();
    if (!aud1 == null){aud1.pause()};
    if (!aud2 == null){aud2.play()};
}
setTimeout(function() {
    if(fadingFrame == 0){
        mainDisplay.activeDisplay = newDisplay;
    }
    else{
        requestAnimationFrame(function(){Fadeframe(oldDisplay,newDisplay,ac1,ac2,func)});
    }
    }, 1000 / fps);
}


var active2 = true;
function Room1frame(){
    currentFrame = (currentFrame+1)%fps;
    if (currentFrame == 0){sec+=1}

    var pos = myCharacter.onFrame(fps); //update frame, and get position
    pos = [pos.x,500-pos.y]; //fix position

    //console.log(pos)

    if(pos[0]>=-64 && pos[0]<1360){
    myCharacterObject.OverridePosition(pos); //update character position
    if(myCharacter.moving == true){ //if charavter is moving then animate
        if (currentFrame % Math.round(fps/12)==0){
        myCharacterObject.UpdateFrame()
        }
    }
    }
    else{
        if(pos[0]<-64){
            myCharacter.position = {x:-64,y:0}
        }
        else{
            myCharacter.position = {x:1360,y:0}
        }
    }

    if (pos[0]>=0 && pos[0]<1000){
    part1Room1ObjectDisplay.OverrideScroll([-pos[0],0]); //scroll everything
    part1Room1ShadowDisplay.OverrideScroll([-pos[0],0]);
    }
        
    if (checkForOverlap(myCharacterObject, boxObject1) || checkForOverlap(myCharacterObject, boxObject2)) {
    console.log("Now press the E key");
    showEKeySprite = true;
    }


    part1Room1ObjectDisplay.draw(1); //objects

    part1Room1Display.draw(1); //update room

    // Drawing the EKey sprite
    if (showEKeySprite) {
        if (currentFrame % Math.round(fps/2)==0){
        Ekey.UpdateFrame()
        }
    //Ekey.OverridePosition([boxObject1.ReturnPosition()[0], boxObject1.ReturnPosition()[1] - Ekey.ReturnScale()[1]]);
    Ekey.draw(part1Room1Display.canvas.getContext("2d"),[0,0]); // Draw the EKey sprite with camera offset
    }


    

    part1Display.draw(1); //update section display

    mainDisplay.draw(1); //update Main Canvas

    setTimeout(function() {if(active2 == true){requestAnimationFrame(Room1frame)}}, 1000 / fps);
}

var active1 = true;
var letterSpacing = 0;
var menuCtx = menuCanvas.getContext("2d");
menuCtx.font = menuText.font;
menuCtx.fillStyle = menuText.fillStyle;
menuCtx.textRendering = "optimizeLegibility"; //won't change much but will hopefully help with the text effect
function Menuframe(){
    console.log(mouseX,mouseY) 
    menuCtx.clearRect(0,0,menuCanvas.width,menuCanvas.height);

    menuDisplay.draw(0); // draw Background

    //much simplier text effect
    if(mouseX <= mainCanvas.width/3 && mouseY >= (mainCanvas.height/2 - mainCanvas.height/10) && mouseY <= (mainCanvas.height/2 + mainCanvas.height/10)){
        if(letterSpacing <10){
            letterSpacing += 1;
        }
    }
    else{
        if(letterSpacing > 0){
            letterSpacing -= 1;
        }
    }
    menuCtx.letterSpacing = String(letterSpacing)+"px"; //update letterSpacing
    
    

    menuCtx.fillText(menuText.text,menuText.posX,menuText.posY); //draw menuText

    mainDisplay.draw(0); //copy to mainDisplay

    setTimeout(function() {if(active1 == true){requestAnimationFrame(Menuframe)}}, 1000 / fps);
}

// onwindow load draw static canvases and start menu music
function start(){
    document.getElementById("start").removeEventListener("click",start);
    document.getElementById("start").style.display = "none";
    
    // Run the game on click
    function startGame(){
        console.log("It Begins!")
        mainCanvas.removeEventListener("click",startGame);
        menuAudio.pause();
        Fadeframe(menuDisplay,part1Display,active1,active2,Room1frame);
    }
    mainCanvas.addEventListener("click",startGame);

    //play audio
    menuAudio.play();
    //load menu
    Menuframe();
};
document.getElementById("start").addEventListener("click",start);
mainCanvas.addEventListener("mousemove",function(event){
    mouseX = event.offsetX;
    mouseY = event.offsetY;
});
</script>